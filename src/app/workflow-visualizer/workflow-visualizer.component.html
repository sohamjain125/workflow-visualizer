<p-toast></p-toast>

<div class="workflow-container">
  <!-- States Container with Table-like Structure -->
  <div class="states-container">
    <!-- Toolbar with title, search, and actions -->
    <div class="table-toolbar">
      <div class="left-section">
        <h3>States Tree</h3>
        <div class="search-section">
          <span class="p-input-icon-left">
    <i class="pi pi-search"></i>
            <input pInputText [(ngModel)]="searchText" placeholder="Search nodes..." (input)="filterNodes()">
  </span>
  <p-dropdown 
    [options]="applicationTypes" 
            [(ngModel)]="selectedApplicationType"
            placeholder="Select Application Type"
            (onChange)="filterNodes()">
          </p-dropdown>
          <button pButton type="button" label="Reset" class="p-button-text" (click)="resetFilters()"></button>
        </div>
      </div>
      <div class="right-section">
  <p-fileUpload 
    mode="basic"
          chooseLabel="Upload JSON" 
    [auto]="true"
          accept=".json" 
          (onSelect)="onFileUpload($event)">
  </p-fileUpload>
        <button pButton type="button" label="View/Edit JSON" (click)="openJsonEditor()"></button>
        <button pButton type="button" label="Download" [disabled]="!treeData.length" (click)="downloadJson()"></button>
        <button pButton type="button" label="Add Node" icon="pi pi-plus" (click)="openAddNodeDialog()"></button>
      </div>
    </div>

    <!-- Table with header and data -->
    <div class="table-content">
      <div class="table-header">
        <div></div>
        <div>Type</div>
        <div>Name</div>
        <div>Details</div>
        <div>Actions</div>
      </div>

      <div class="table-body">
        <p-tree [value]="filterNodes()" 
                [filter]="false"
                [filterBy]="'name'">
          <ng-template pTemplate="default" let-node>
            <div class="tree-node-row">
              <div class="tree-toggler">
                <!-- Tree toggler will be placed here automatically -->
              </div>
              
              <div class="col-type">
                <span [ngSwitch]="node.data._type || node.data.type">
                  <span class="state-badge" *ngSwitchCase="'state'">
                    <i class="pi pi-circle-fill"></i>
                    <span>State</span>
                  </span>
                  <span class="transition-badge" *ngSwitchCase="'transition'">
                    <i class="pi pi-arrow-right"></i>
                    <span>Transition</span>
                  </span>
                  <span class="action-badge" *ngSwitchCase="'action'">
                    <i class="pi pi-cog"></i>
                    <span>{{node.data.actionType || 'Action'}}</span>
                  </span>
                  <span class="template-badge" *ngSwitchCase="'template'">
                    <i class="pi pi-file"></i>
                    <span>Template</span>
                  </span>
                  <span class="reminder-badge" *ngSwitchCase="'reminder'">
                    <i class="pi pi-clock"></i>
                    <span>Reminder</span>
                  </span>
                </span>
              </div>

              <div class="col-name">
                <span class="node-name" [title]="node.data.name">{{node.data.name}}</span>
              </div>

              <div class="col-details">
                <div class="details-container">
                  <ng-container [ngSwitch]="node.data._type || node.data.type">
                    <!-- State Details -->
                    <div class="details-group" *ngSwitchCase="'state'">
                      <span class="detail-item" *ngIf="node.data.idleDays">
                        <i class="pi pi-calendar"></i>
                        {{node.data.idleDays}} days
                      </span>
                      <span class="detail-item" *ngIf="node.data.assignedStaff">
                        <i class="pi pi-user"></i>
                        {{node.data.assignedStaff}}
                      </span>
                    </div>

                    <!-- Transition Details -->
                    <div *ngSwitchCase="'transition'" class="details-container">
                      <span *ngIf="node.data.next" class="detail-item">
                        <i class="pi pi-arrow-right"></i> {{node.data.next}}
                      </span>
                      <span *ngIf="node.data.selectAttachment" class="detail-item">
                        <i class="pi pi-paperclip"></i> Requires Attachment
                      </span>
                    </div>

                    <!-- Action Details -->
                    <div *ngSwitchCase="'action'" class="details-container">
                      <ng-container [ngSwitch]="node.data.actionType">
                        <div *ngSwitchCase="'email'" class="details-group">
                          <span class="detail-item"><i class="pi pi-envelope"></i> {{node.data.addressee?.join(', ')}}</span>
                          <span *ngIf="node.data.subject" class="detail-item"><i class="pi pi-info-circle"></i> {{node.data.subject}}</span>
                          <span *ngIf="node.data.previewOnly" class="detail-item"><i class="pi pi-eye"></i> Preview Only</span>
                        </div>
                        <div *ngSwitchCase="'sms'" class="details-group">
                          <span class="detail-item"><i class="pi pi-mobile"></i> {{node.data.addressee?.join(', ')}}</span>
                          <span *ngIf="node.data.content" class="detail-item"><i class="pi pi-comment"></i> {{node.data.content}}</span>
                        </div>
                        <div *ngSwitchCase="'task'" class="details-group">
                          <span class="detail-item"><i class="pi pi-user"></i> {{node.data.addressee?.join(', ')}}</span>
                          <span *ngIf="node.data.isReviewable" class="detail-item"><i class="pi pi-check-square"></i> Reviewable</span>
                        </div>
                        <div *ngSwitchCase="'document'" class="details-group">
                          <span class="detail-item"><i class="pi pi-file"></i> {{node.data.docType}}</span>
                          <span *ngIf="node.data.documentFolder" class="detail-item">
                            <i class="pi pi-folder"></i> {{node.data.documentFolder}}
                          </span>
                          <span *ngIf="node.data.access" class="detail-item">
                            <i class="pi pi-lock"></i> {{node.data.access}}
                          </span>
                        </div>
                        <div *ngSwitchCase="'decision'" class="details-group">
                          <span class="detail-item"><i class="pi pi-check-circle"></i> {{node.data.decisionType}}</span>
                          <span *ngIf="node.data.commencedBy" class="detail-item">
                            <i class="pi pi-calendar"></i> Commenced: {{node.data.commencedBy}} days
                          </span>
                          <span *ngIf="node.data.completedBy" class="detail-item">
                            <i class="pi pi-calendar-times"></i> Completed: {{node.data.completedBy}} days
                          </span>
                          <span *ngIf="node.data.costOfDevelopment" class="detail-item">
                            <i class="pi pi-dollar"></i> {{node.data.costOfDevelopment}}
                          </span>
                        </div>
                      </ng-container>
                    </div>

                    <!-- Template Details -->
                    <div *ngSwitchCase="'template'" class="details-container">
                      <span *ngIf="node.data.saveToRelatedDoc" class="detail-item">
                        <i class="pi pi-save"></i> Save to Related Doc
                      </span>
                      <span *ngIf="node.data.securePDF" class="detail-item">
                        <i class="pi pi-lock"></i> Secure PDF
                      </span>
                    </div>

                    <!-- Reminder Details -->
                    <div *ngSwitchCase="'reminder'" class="details-container">
                      <span class="detail-item">
                        <i class="pi pi-bell"></i> {{node.data.content}}
                      </span>
                    </div>
                  </ng-container>
                </div>
              </div>

              <div class="col-actions">
                <button pButton type="button" icon="pi pi-plus" class="p-button-text" (click)="openAddNodeDialog(node)" pTooltip="Add child node"></button>
                <button pButton type="button" icon="pi pi-pencil" class="p-button-text" (click)="startEdit(node)"></button>
                <button pButton type="button" icon="pi pi-trash" class="p-button-text" (click)="deleteNode(node)"></button>
              </div>
            </div>
          </ng-template>
        </p-tree>
      </div>
    </div>
  </div>
</div>

<!-- Add Node Dialog -->
<p-dialog [(visible)]="showAddNodeDialog" 
          [header]="'Add New ' + (multiNodeForm.type || 'Nodes')"
          [modal]="true" 
          [style]="{width: '70vw'}" 
          [draggable]="false" 
          [resizable]="false">
    
    <div class="p-fluid">
        <!-- Node Type Selection -->
        <div class="field">
            <label for="nodeType">Node Type</label>
            <p-dropdown id="nodeType"
                      [(ngModel)]="multiNodeForm.type"
                      [options]="getAvailableNodeTypes()"
                      placeholder="Select a node type"
                      [required]="true">
            </p-dropdown>
        </div>

        <div class="nodes-container">
            <div *ngFor="let nodeForm of multiNodeForm.nodes; let i = index" class="node-form">
                <div class="node-form-header">
                    <h4>Node {{i + 1}}</h4>
                    <button pButton type="button" 
                            icon="pi pi-trash" 
                            class="p-button-text p-button-danger"
                            (click)="removeNodeForm(i)"
                            [disabled]="multiNodeForm.nodes.length === 1">
                    </button>
                </div>

                <!-- State Fields -->
                <div *ngIf="multiNodeForm.type === 'state'" class="field">
                    <div class="field">
                        <label for="stateName{{i}}">State Name</label>
                        <input [id]="'stateName' + i" type="text" pInputText [(ngModel)]="nodeForm.name" required>
                    </div>
                    <div class="field">
                        <label for="idleDays{{i}}">Idle Days</label>
                        <input [id]="'idleDays' + i" type="number" pInputText [(ngModel)]="nodeForm.idleDays" required>
                    </div>
                </div>

                <!-- Transition Fields -->
                <div *ngIf="multiNodeForm.type === 'transition'" class="field">
                    <div class="field">
                        <label for="input{{i}}">Input</label>
                        <input [id]="'input' + i" type="text" pInputText [(ngModel)]="nodeForm.input" required>
                    </div>
                    <div class="field">
                        <label for="next{{i}}">Next State</label>
                        <input [id]="'next' + i" type="text" pInputText [(ngModel)]="nodeForm.next" required>
                    </div>
                    <div class="field">
                        <label for="selectAttachment{{i}}">Select Attachment</label>
                        <p-checkbox [id]="'selectAttachment' + i"
                                  [(ngModel)]="nodeForm.selectAttachment"
                                  [binary]="true">
                        </p-checkbox>
                    </div>
                </div>

                <!-- Action Fields -->
                <div *ngIf="multiNodeForm.type === 'action'" class="field">
                    <div class="field">
                        <label for="actionType{{i}}">Action Type</label>
                        <p-dropdown [id]="'actionType' + i"
                                  [(ngModel)]="nodeForm.actionType"
                                  [options]="actionTypes"
                                  placeholder="Select action type"
                                  [required]="true">
                        </p-dropdown>
                    </div>
                    <div class="field">
                        <label for="addressee{{i}}">Addressee</label>
                        <p-multiSelect [id]="'addressee' + i"
                                     [(ngModel)]="nodeForm.addressee"
                                     [options]="addresseeOptions"
                                     [required]="true">
                        </p-multiSelect>
                    </div>
                    <div class="field">
                        <label for="subject{{i}}">Subject</label>
                        <input [id]="'subject' + i" type="text" pInputText [(ngModel)]="nodeForm.subject">
                    </div>
                    <div class="field">
                        <label for="template{{i}}">Template</label>
                        <input [id]="'template' + i" type="text" pInputText [(ngModel)]="nodeForm.template">
                    </div>
                    <div class="field">
                        <label for="content{{i}}">Content</label>
                        <textarea [id]="'content' + i" pInputTextarea [(ngModel)]="nodeForm.content" rows="3"></textarea>
                    </div>
                </div>

                <!-- Template Fields -->
                <div *ngIf="multiNodeForm.type === 'template'" class="field">
                    <div class="field">
                        <label for="templateName{{i}}">Template Name</label>
                        <input [id]="'templateName' + i" type="text" pInputText [(ngModel)]="nodeForm.name" required>
                    </div>
                    <div class="field">
                        <label for="saveToRelatedDoc{{i}}">Save to Related Doc</label>
                        <p-checkbox [id]="'saveToRelatedDoc' + i"
                                  [(ngModel)]="nodeForm.saveToRelatedDoc"
                                  [binary]="true">
                        </p-checkbox>
                    </div>
                    <div class="field">
                        <label for="securePDF{{i}}">Secure PDF</label>
                        <p-checkbox [id]="'securePDF' + i"
                                  [(ngModel)]="nodeForm.securePDF"
                                  [binary]="true">
                        </p-checkbox>
                    </div>
                </div>

                <!-- Reminder Fields -->
                <div *ngIf="multiNodeForm.type === 'reminder'" class="field">
                    <div class="field">
                        <label for="reminderContent{{i}}">Content</label>
                        <textarea [id]="'reminderContent' + i"
                                 pInputTextarea 
                                 [(ngModel)]="nodeForm.content" 
                                 rows="3" 
                                 required>
                        </textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="add-node-button">
            <button pButton type="button"
                    label="Add Another Node"
                    icon="pi pi-plus"
                    class="p-button-text"
                    (click)="addNewNodeForm()">
            </button>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton 
                label="Cancel" 
                icon="pi pi-times" 
                class="p-button-text" 
                (click)="cancelAddNode()">
        </button>
        <button pButton 
                label="Add Nodes" 
                icon="pi pi-check" 
                class="p-button-text" 
                (click)="addNodes()">
        </button>
    </ng-template>
</p-dialog>

<!-- Edit Node Dialog -->
<p-dialog [(visible)]="editDialogVisible" 
          [header]="'Edit ' + (selectedNode?.data.type || '')" 
          [modal]="true" 
          [style]="{width: '600px'}"
          [maximizable]="true">
  <div class="edit-form">
    <!-- Common fields -->
    <div class="p-field">
      <label>Name</label>
      <input pInputText [(ngModel)]="editForm.name" class="p-inputtext-lg" style="width: 100%">
    </div>

    <!-- State specific fields -->
    <div *ngIf="selectedNode?.data.type === 'state'">
      <div class="p-field">
        <label>Idle Days</label>
        <input pInputText [(ngModel)]="editForm.idleDays" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Assigned Staff</label>
        <input pInputText [(ngModel)]="editForm.assignedStaff" class="p-inputtext-lg" style="width: 100%">
      </div>
    </div>

    <!-- Transition specific fields -->
    <div *ngIf="selectedNode?.data.type === 'transition'">
      <div class="p-field">
        <label>Input</label>
        <input pInputText [(ngModel)]="editForm.input" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Next State</label>
        <input pInputText [(ngModel)]="editForm.next" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Select Attachment</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.selectAttachment"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
    </div>
    
    <!-- Template specific fields -->
    <div *ngIf="selectedNode?.data.type === 'template'">
      <div class="p-field">
        <label>Save to Related Doc</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.saveToRelatedDoc"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
      <div class="p-field">
        <label>Secure PDF</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.securePDF"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
    </div>

    <!-- Action specific fields -->
    <div *ngIf="selectedNode?.data.type === 'action'">
      <div class="p-field">
        <label>Action Type</label>
        <p-dropdown [options]="actionTypes" 
                   [(ngModel)]="editForm.actionType"
                   [style]="{'width': '100%'}"
                   placeholder="Select Action Type">
        </p-dropdown>
      </div>

      <div class="p-field">
        <label>Addressee</label>
        <p-multiSelect [options]="addresseeOptions" 
                      [(ngModel)]="editForm.addressee"
                      [style]="{'width': '100%'}"
                      placeholder="Select Addressees"
                      [filter]="true">
        </p-multiSelect>
      </div>

      <div class="p-field">
        <label>Template</label>
        <input pInputText [(ngModel)]="editForm.template" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="['email', 'sms'].includes(editForm.actionType || '')">
        <label>Subject</label>
        <input pInputText [(ngModel)]="editForm.subject" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'sms'">
        <label>Content</label>
        <textarea pInputTextarea [(ngModel)]="editForm.content" [rows]="3" style="width: 100%"></textarea>
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Document Type</label>
        <input pInputText [(ngModel)]="editForm.docType" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Document Folder</label>
        <input pInputText [(ngModel)]="editForm.documentFolder" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Access</label>
        <input pInputText [(ngModel)]="editForm.access" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Mail Merge Data Source</label>
        <input pInputText [(ngModel)]="editForm.mailMergeDataSource" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="['task', 'decision', 'email'].includes(editForm.actionType || '')">
        <label>Is Reviewable</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.isReviewable"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'email'">
        <label>Preview Only</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.previewOnly"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Decision specific fields -->
      <div *ngIf="editForm.actionType === 'decision'">
        <div class="p-field">
          <label>Decision Type</label>
          <textarea pInputTextarea [(ngModel)]="editForm.decisionType" [rows]="3" style="width: 100%"></textarea>
        </div>

        <div class="p-field">
          <label>Commenced By (days)</label>
          <input pInputText [(ngModel)]="editForm.commencedBy" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Completed By (days)</label>
          <input pInputText [(ngModel)]="editForm.completedBy" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Display Location</label>
          <input pInputText [(ngModel)]="editForm.displayLocation" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Cost of Development</label>
          <input pInputText [(ngModel)]="editForm.costOfDevelopment" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Building Part</label>
          <input pInputText [(ngModel)]="editForm.OPBuildingPart" class="p-inputtext-lg" style="width: 100%">
              </div>

        <div class="p-field">
          <label>Combine Allotment</label>
          <p-dropdown [options]="booleanOptions" 
                     [(ngModel)]="editForm.isCombineAllotment"
                     [style]="{'width': '100%'}">
          </p-dropdown>
          </div>

        <div class="p-field">
          <label>Is Subdivision</label>
          <p-dropdown [options]="booleanOptions" 
                     [(ngModel)]="editForm.isSubdivision"
                     [style]="{'width': '100%'}">
          </p-dropdown>
        </div>
      </div>
    </div>
</div>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="cancelEdit()"></button>
    <button pButton label="Save" class="p-button-primary" (click)="saveEdit()"></button>
  </ng-template>
</p-dialog>

<!-- JSON Editor Dialog -->
<p-dialog [(visible)]="showJsonEditor" 
          header="Edit JSON" 
          [modal]="true" 
          [style]="{width: '50vw'}"
          [maximizable]="true">
  <div class="json-editor">
    <textarea pInputTextarea 
              [(ngModel)]="jsonEditorContent" 
              [rows]="20" 
              [style]="{width: '100%', fontFamily: 'monospace'}"
              class="json-textarea">
    </textarea>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" (click)="closeJsonEditor()" class="p-button-text"></button>
    <button pButton label="Apply" icon="pi pi-check" (click)="applyJsonChanges()"></button>
  </ng-template>
</p-dialog>
