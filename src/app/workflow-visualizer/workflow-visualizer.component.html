<p-toast></p-toast>

<div class="workflow-container">
  <div class="header-section">
    <h2>States Tree</h2>
    <div class="table-toolbar">
      <div class="search-section">
        <span class="p-input-icon-left">
    <i class="pi pi-search"></i>
          <input pInputText [(ngModel)]="searchText" placeholder="Search..." />
  </span>
  <p-dropdown 
          [(ngModel)]="selectedApplicationType" 
    [options]="applicationTypes" 
          placeholder="Select Application Type"
          [showClear]="true">
        </p-dropdown>
        <button pButton type="button" label="Reset Filters" (click)="resetFilters()"></button>
      </div>
      <div class="action-buttons">
        <button pButton type="button" icon="pi pi-upload" label="Upload JSON" (click)="fileInput.click()"></button>
        <input #fileInput type="file" (change)="onFileSelected($event)" accept="application/json" style="display: none">
        <button pButton type="button" icon="pi pi-code" label="View/Edit JSON" (click)="showJsonDialog()"></button>
        <button pButton type="button" icon="pi pi-download" label="Download" (click)="downloadJson()"></button>
        <button pButton type="button" icon="pi pi-plus" label="Add Node" (click)="openAddNodeDialog()"></button>
</div>
    </div>
  </div>

  <div class="table-section">
    <div class="table-header">
      <div></div>
      <div>Type</div>
      <div>Name</div>
      <div>Details</div>
      <div>Actions</div>
    </div>

    <p-tree [value]="treeNodes" [loading]="loading">
      <ng-template pTemplate="default" let-node>
        <div class="tree-node-row">
          <div class="col-expand"></div>
          <div class="col-type">
          <span class="node-type" [ngClass]="{
              'state-badge': node.data.type === 'state' || node.data._type === 'state',
              'transition-badge': node.data.type === 'transition',
              'action-badge': node.data.type === 'action' || node.data._type === 'action'
            }">
              <i [class]="getNodeIcon(node)"></i>
              {{getNodeType(node)}}
            </span>
          </div>
          <div class="col-name">
            <span class="node-name">{{node.data.name}}</span>
          </div>
          <div class="col-details">
            <ng-container [ngSwitch]="node.data.type || node.data._type">
              <!-- State Details -->
              <div class="details-group" *ngSwitchCase="'state'">
                <span class="detail-item" *ngIf="node.data.idleDays">
                  <i class="pi pi-calendar"></i>
                  {{node.data.idleDays}} days
                </span>
                <span class="detail-item" *ngIf="node.data.assignedStaff">
                  <i class="pi pi-user"></i>
                  {{node.data.assignedStaff}}
                </span>
              </div>

              <!-- Transition Details -->
              <div *ngSwitchCase="'transition'" class="details-container">
                <span *ngIf="node.data.next" class="detail-item">
                  <i class="pi pi-arrow-right"></i> {{node.data.next}}
                </span>
                <span *ngIf="node.data.selectAttachment" class="detail-item">
                  <i class="pi pi-paperclip"></i> Requires Attachment
                </span>
              </div>

              <!-- Action Details -->
              <div *ngSwitchCase="'action'" class="details-container">
                <ng-container [ngSwitch]="node.data.actionType">
                  <div *ngSwitchCase="'email'" class="details-group">
                    <span class="detail-item"><i class="pi pi-envelope"></i> {{node.data.addressee?.join(', ')}}</span>
                    <span *ngIf="node.data.subject" class="detail-item"><i class="pi pi-info-circle"></i> {{node.data.subject}}</span>
                    <span *ngIf="node.data.previewOnly" class="detail-item"><i class="pi pi-eye"></i> Preview Only</span>
                  </div>
                  <div *ngSwitchCase="'sms'" class="details-group">
                    <span class="detail-item"><i class="pi pi-mobile"></i> {{node.data.addressee?.join(', ')}}</span>
                    <span *ngIf="node.data.content" class="detail-item"><i class="pi pi-comment"></i> {{node.data.content}}</span>
                  </div>
                  <div *ngSwitchCase="'task'" class="details-group">
                    <span class="detail-item"><i class="pi pi-user"></i> {{node.data.addressee?.join(', ')}}</span>
                    <span *ngIf="node.data.isReviewable" class="detail-item"><i class="pi pi-check-square"></i> Reviewable</span>
                  </div>
                  <div *ngSwitchCase="'document'" class="details-group">
                    <span class="detail-item"><i class="pi pi-file"></i> {{node.data.docType}}</span>
                    <span *ngIf="node.data.documentFolder" class="detail-item">
                      <i class="pi pi-folder"></i> {{node.data.documentFolder}}
                    </span>
                    <span *ngIf="node.data.access" class="detail-item">
                      <i class="pi pi-lock"></i> {{node.data.access}}
                    </span>
                  </div>
                  <div *ngSwitchCase="'decision'" class="details-group">
                    <span class="detail-item"><i class="pi pi-check-circle"></i> {{node.data.decisionType}}</span>
                    <span *ngIf="node.data.commencedBy" class="detail-item">
                      <i class="pi pi-calendar"></i> Commenced: {{node.data.commencedBy}} days
                    </span>
                    <span *ngIf="node.data.completedBy" class="detail-item">
                      <i class="pi pi-calendar-times"></i> Completed: {{node.data.completedBy}} days
                    </span>
                    <span *ngIf="node.data.costOfDevelopment" class="detail-item">
                      <i class="pi pi-dollar"></i> {{node.data.costOfDevelopment}}
          </span>
                  </div>
                </ng-container>
              </div>

              <!-- Template Details -->
              <div *ngSwitchCase="'template'" class="details-container">
                <span *ngIf="node.data.saveToRelatedDoc" class="detail-item">
                  <i class="pi pi-save"></i> Save to Related Doc
                </span>
                <span *ngIf="node.data.securePDF" class="detail-item">
                  <i class="pi pi-lock"></i> Secure PDF
                </span>
              </div>

              <!-- Reminder Details -->
              <div *ngSwitchCase="'reminder'" class="details-container">
                <span class="detail-item">
                  <i class="pi pi-bell"></i> {{node.data.content}}
                </span>
              </div>
            </ng-container>
          </div>
          <div class="col-actions">
            <button pButton type="button" icon="pi pi-pencil" class="p-button-text" (click)="editNode(node)"></button>
            <button pButton type="button" icon="pi pi-ellipsis-v" class="p-button-text" (click)="menu.toggle($event)"></button>
          </div>
        </div>
    </ng-template>
    </p-tree>
  </div>
</div>

<!-- Add Node Dialog -->
<p-dialog [(visible)]="showAddNodeDialog" 
          header="Add New Node" 
          [modal]="true" 
          [style]="{width: '400px'}">
  <div class="add-node-form">
    <div class="p-field">
      <label>Node Type</label>
      <p-dropdown [options]="nodeTypes" 
                 [(ngModel)]="newNodeForm.type"
                 [style]="{'width': '100%'}"
                 placeholder="Select Node Type">
      </p-dropdown>
    </div>

    <div class="p-field">
      <label>Name</label>
      <input pInputText [(ngModel)]="newNodeForm.name" 
             class="p-inputtext-lg" 
             style="width: 100%">
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="cancelAddNode()"></button>
    <button pButton label="Add" class="p-button-primary" (click)="addNode()"></button>
  </ng-template>
</p-dialog>

<!-- Edit Node Dialog -->
<p-dialog [(visible)]="editDialogVisible" 
          [header]="'Edit ' + (selectedNode?.data.type || '')" 
          [modal]="true" 
          [style]="{width: '600px'}"
          [maximizable]="true">
  <div class="edit-form">
    <!-- Common fields -->
    <div class="p-field">
      <label>Name</label>
      <input pInputText [(ngModel)]="editForm.name" class="p-inputtext-lg" style="width: 100%">
    </div>

    <!-- State specific fields -->
    <div *ngIf="selectedNode?.data.type === 'state'">
      <div class="p-field">
        <label>Idle Days</label>
        <input pInputText [(ngModel)]="editForm.idleDays" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Assigned Staff</label>
        <input pInputText [(ngModel)]="editForm.assignedStaff" class="p-inputtext-lg" style="width: 100%">
      </div>
    </div>

    <!-- Transition specific fields -->
    <div *ngIf="selectedNode?.data.type === 'transition'">
      <div class="p-field">
        <label>Input</label>
        <input pInputText [(ngModel)]="editForm.input" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Next State</label>
        <input pInputText [(ngModel)]="editForm.next" class="p-inputtext-lg" style="width: 100%">
      </div>
      <div class="p-field">
        <label>Select Attachment</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.selectAttachment"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
    </div>
    
    <!-- Template specific fields -->
    <div *ngIf="selectedNode?.data.type === 'template'">
      <div class="p-field">
        <label>Save to Related Doc</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.saveToRelatedDoc"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
      <div class="p-field">
        <label>Secure PDF</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.securePDF"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>
    </div>

    <!-- Action specific fields -->
    <div *ngIf="selectedNode?.data.type === 'action'">
      <div class="p-field">
        <label>Action Type</label>
        <p-dropdown [options]="actionTypes" 
                   [(ngModel)]="editForm.actionType"
                   [style]="{'width': '100%'}"
                   placeholder="Select Action Type">
        </p-dropdown>
      </div>

      <div class="p-field">
        <label>Addressee</label>
        <p-multiSelect [options]="addresseeOptions" 
                      [(ngModel)]="editForm.addressee"
                      [style]="{'width': '100%'}"
                      placeholder="Select Addressees"
                      [filter]="true">
        </p-multiSelect>
      </div>

      <div class="p-field">
        <label>Template</label>
        <input pInputText [(ngModel)]="editForm.template" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="['email', 'sms'].includes(editForm.actionType || '')">
        <label>Subject</label>
        <input pInputText [(ngModel)]="editForm.subject" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'sms'">
        <label>Content</label>
        <textarea pInputTextarea [(ngModel)]="editForm.content" [rows]="3" style="width: 100%"></textarea>
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Document Type</label>
        <input pInputText [(ngModel)]="editForm.docType" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Document Folder</label>
        <input pInputText [(ngModel)]="editForm.documentFolder" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Access</label>
        <input pInputText [(ngModel)]="editForm.access" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'document'">
        <label>Mail Merge Data Source</label>
        <input pInputText [(ngModel)]="editForm.mailMergeDataSource" class="p-inputtext-lg" style="width: 100%">
      </div>

      <div class="p-field" *ngIf="['task', 'decision', 'email'].includes(editForm.actionType || '')">
        <label>Is Reviewable</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.isReviewable"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <div class="p-field" *ngIf="editForm.actionType === 'email'">
        <label>Preview Only</label>
        <p-dropdown [options]="booleanOptions" 
                   [(ngModel)]="editForm.previewOnly"
                   [style]="{'width': '100%'}">
        </p-dropdown>
      </div>

      <!-- Decision specific fields -->
      <div *ngIf="editForm.actionType === 'decision'">
        <div class="p-field">
          <label>Decision Type</label>
          <textarea pInputTextarea [(ngModel)]="editForm.decisionType" [rows]="3" style="width: 100%"></textarea>
        </div>

        <div class="p-field">
          <label>Commenced By (days)</label>
          <input pInputText [(ngModel)]="editForm.commencedBy" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Completed By (days)</label>
          <input pInputText [(ngModel)]="editForm.completedBy" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Display Location</label>
          <input pInputText [(ngModel)]="editForm.displayLocation" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Cost of Development</label>
          <input pInputText [(ngModel)]="editForm.costOfDevelopment" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Building Part</label>
          <input pInputText [(ngModel)]="editForm.OPBuildingPart" class="p-inputtext-lg" style="width: 100%">
        </div>

        <div class="p-field">
          <label>Combine Allotment</label>
          <p-dropdown [options]="booleanOptions" 
                     [(ngModel)]="editForm.isCombineAllotment"
                     [style]="{'width': '100%'}">
          </p-dropdown>
        </div>

        <div class="p-field">
          <label>Is Subdivision</label>
          <p-dropdown [options]="booleanOptions" 
                     [(ngModel)]="editForm.isSubdivision"
                     [style]="{'width': '100%'}">
          </p-dropdown>
        </div>
      </div>
    </div>
</div>
  
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" class="p-button-text" (click)="cancelEdit()"></button>
    <button pButton label="Save" class="p-button-primary" (click)="saveEdit()"></button>
  </ng-template>
</p-dialog>

<!-- JSON Editor Dialog -->
<p-dialog [(visible)]="showJsonEditor" 
          header="Edit JSON" 
          [modal]="true" 
          [style]="{width: '50vw'}"
          [maximizable]="true">
  <div class="json-editor">
    <textarea pInputTextarea 
              [(ngModel)]="jsonEditorContent" 
              [rows]="20" 
              [style]="{width: '100%', fontFamily: 'monospace'}"
              class="json-textarea">
    </textarea>
  </div>
  <ng-template pTemplate="footer">
    <button pButton label="Cancel" icon="pi pi-times" (click)="closeJsonEditor()" class="p-button-text"></button>
    <button pButton label="Apply" icon="pi pi-check" (click)="applyJsonChanges()"></button>
  </ng-template>
</p-dialog>
